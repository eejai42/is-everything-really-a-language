<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Substrate Report: binary</title>
    <style>
:root {
    --bg-primary: #ffffff; --bg-secondary: #f8f9fa; --bg-tertiary: #e9ecef;
    --text-primary: #212529; --text-secondary: #6c757d; --border-color: #dee2e6;
    --accent-color: #0d6efd; --success-color: #198754; --warning-color: #ffc107;
    --danger-color: #dc3545; --code-bg: #f6f8fa; --shadow: 0 2px 8px rgba(0,0,0,0.1); --radius: 6px;
}
[data-theme="dark"] {
    --bg-primary: #1a1a2e; --bg-secondary: #16213e; --bg-tertiary: #0f3460;
    --text-primary: #eaeaea; --text-secondary: #b0b0b0; --border-color: #3a3a5c;
    --accent-color: #4dabf7; --success-color: #51cf66; --warning-color: #fcc419;
    --danger-color: #ff6b6b; --code-bg: #0d1117; --shadow: 0 2px 8px rgba(0,0,0,0.3);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-secondary); color: var(--text-primary); line-height: 1.5; min-height: 100vh; }
header { background: var(--bg-primary); border-bottom: 1px solid var(--border-color); padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; }
.header-left { display: flex; align-items: center; gap: 0.75rem; }
.substrate-icon { font-size: 1.5rem; }
h1 { font-size: 1.1rem; font-weight: 600; }
.header-stats { display: flex; gap: 1rem; font-size: 0.8rem; }
.stat { display: flex; align-items: center; gap: 0.25rem; }
.stat-value { font-weight: 600; }
.score-perfect, .score-good { color: var(--success-color); }
.score-warning { color: var(--warning-color); }
.score-danger { color: var(--danger-color); }
#theme-toggle { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 50%; width: 28px; height: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
#theme-toggle:hover { background: var(--accent-color); color: white; }
#theme-toggle .moon { display: none; }
[data-theme="dark"] #theme-toggle .sun { display: none; }
[data-theme="dark"] #theme-toggle .moon { display: inline; }
.tabs { display: flex; background: var(--bg-primary); border-bottom: 1px solid var(--border-color); overflow-x: auto; padding: 0 0.5rem; }
.tab { background: none; border: none; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.8rem; color: var(--text-secondary); border-bottom: 2px solid transparent; white-space: nowrap; }
.tab:hover { color: var(--text-primary); }
.tab.active { color: var(--accent-color); border-bottom-color: var(--accent-color); font-weight: 500; }
main { padding: 1rem; }
.tab-content { display: none; }
.tab-content.active { display: block; animation: fadeIn 0.2s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.card { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem; box-shadow: var(--shadow); }
.card h2 { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem; }
pre { background: var(--code-bg); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 0.75rem; overflow-x: auto; font-family: 'SF Mono', Monaco, monospace; font-size: 0.75rem; line-height: 1.4; max-height: 500px; overflow-y: auto; }
.code-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
.code-info { font-size: 0.75rem; color: var(--text-secondary); }
.copy-btn { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.25rem 0.5rem; font-size: 0.7rem; cursor: pointer; }
.copy-btn:hover { background: var(--accent-color); color: white; }
.markdown-content { line-height: 1.6; }
.markdown-content p { margin-bottom: 0.75rem; }
.markdown-content ul, .markdown-content ol { margin-left: 1.5rem; margin-bottom: 0.75rem; }
.markdown-content li { margin-bottom: 0.25rem; }
.markdown-content code { background: var(--code-bg); padding: 0.125rem 0.375rem; border-radius: 3px; font-size: 0.85em; }
.results-summary { display: flex; gap: 1.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
.result-item { text-align: center; }
.result-value { font-size: 1.5rem; font-weight: 700; }
.result-label { font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; }
.binary-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem; }
.binary-stat { background: var(--bg-tertiary); padding: 0.75rem; border-radius: var(--radius); text-align: center; }
.binary-stat-value { font-size: 1.25rem; font-weight: 700; color: var(--accent-color); }
.binary-stat-label { font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <span class="substrate-icon">üîß</span>
            <h1>Binary (ARM64) Execution Substrate</h1>
        </div>
        <div class="header-stats">
            <div class="stat"><span>Score:</span><span class="stat-value score-perfect">100.0%</span></div>
            <div class="stat"><span>3/3 passed</span></div>
        </div>
        <button id="theme-toggle" title="Toggle theme"><span class="sun">‚òÄÔ∏è</span><span class="moon">üåô</span></button>
    </header>
    <nav class="tabs">
        <button class="tab active" data-tab="description">Description</button>
        <button class="tab" data-tab="log">Run Log</button>
        <button class="tab" data-tab="results">Test Results</button>
        <button class="tab" data-tab="assembly">Assembly Code</button>
        <button class="tab" data-tab="binary">Binary Info</button>
    </nav>
    <main>
        <div id="description" class="tab-content active">
            <div class="card">
                <h2>What This Substrate Does</h2>
                <div class="markdown-content">
                    <p>The Binary substrate compiles rulebook formulas directly to ARM64 assembly language, producing a native dynamic library for maximum performance.</p>
                    <h3>Orchestration Pattern</h3>
                    <ol>
                        <li><strong>Generate</strong>: <code>inject-into-binary.py</code> compiles formulas to ARM64 assembly</li>
                        <li><strong>Assemble</strong>: <code>as</code> assembles to object file (<code>erb_calc.o</code>)</li>
                        <li><strong>Link</strong>: Creates dynamic library (<code>erb_calc.dylib</code>)</li>
                        <li><strong>Execute</strong>: Python ctypes loads and calls native functions</li>
                        <li><strong>Test</strong>: Compare computed values against expected answers</li>
                    </ol>
                </div>
            </div>
            <div class="card">
                <h2>Key Features</h2>
                <ul class="markdown-content">
                    <li><strong>Native Performance</strong>: Direct ARM64 machine code execution</li>
                    <li><strong>DAG Ordering</strong>: Calculations in dependency order</li>
                    <li><strong>ABI Compliant</strong>: Standard calling conventions for interop</li>
                    <li><strong>Zero Dependencies</strong>: Self-contained binary with no runtime</li>
                </ul>
            </div>
        </div>
        <div id="log" class="tab-content">
            <div class="card">
                <h2>Execution Log</h2>
                <pre>=== Binary (ARM64) Substrate Test Run ===

======================================================================
Binary Execution Substrate - Multi-Entity Test Execution
======================================================================

Loaded library: /Users/eejai42/effortlessapi-app-root/users/user_ee42ai73-18a9-47d5-8f99-954b00f6c041/my-projects/ERB_effortless-rulebook-starter/execution-substrates/binary/erb_calc.dylib
Loading rulebook...
Discovered 1 entities: Customers
  Schema for customers: 6 fields, 96 bytes
    Found: eval_customers_full_name -&gt; string
  -&gt; customers: 3 records

Binary substrate: Processed 1 entities, 3 total records
======================================================================

</pre>
            </div>
        </div>
        <div id="results" class="tab-content">
            <div class="card">
                <h2>Test Summary</h2>
                <div class="results-summary">
                    <div class="result-item"><div class="result-value score-perfect">100.0%</div><div class="result-label">Score</div></div>
                    <div class="result-item"><div class="result-value score-perfect">3</div><div class="result-label">Passed</div></div>
                    <div class="result-item"><div class="result-value">0</div><div class="result-label">Failed</div></div>
                    <div class="result-item"><div class="result-value">3</div><div class="result-label">Total</div></div>
                </div>
            </div>
        </div>
        <div id="assembly" class="tab-content">
            <div class="card">
                <div class="code-header">
                    <h2>erb_calc.s (ARM64 Assembly)</h2>
                    <div><span class="code-info">219 lines</span><button class="copy-btn" onclick="copyCode('asm-code')">Copy</button></div>
                </div>
                <pre id="asm-code">
; ERB Binary Substrate - Generated Assembly (ARM64 / Apple Silicon)
; Generated from rulebook formulas - DO NOT HAND-EDIT
;
; This file is GENERATED by inject-into-binary.py
; The formulas are the source of truth, not this assembly.


; String runtime for ERB Binary Substrate (ARM64 / Apple Silicon)
; Calling convention: Apple ARM64 ABI

    .text
    .p2align 2

; bool _string_equals(const char* s1, size_t len1, const char* s2, size_t len2)
; x0 = s1, x1 = len1, x2 = s2, x3 = len2
; Returns 1 if strings are equal, 0 otherwise in w0
    .globl _string_equals
_string_equals:
    cmp x1, x3                  ; Compare lengths first
    b.ne Lstr_eq_false
    cbz x1, Lstr_eq_true        ; If both empty, equal

    ; Compare byte by byte
    mov x4, #0                  ; index
Lstr_eq_loop:
    ldrb w5, [x0, x4]
    ldrb w6, [x2, x4]
    cmp w5, w6
    b.ne Lstr_eq_false
    add x4, x4, #1
    cmp x4, x1
    b.lt Lstr_eq_loop

Lstr_eq_true:
    mov w0, #1
    ret

Lstr_eq_false:
    mov w0, #0
    ret

; char* _string_concat(char* dest, const char* s1, size_t len1, const char* s2, size_t len2)
; x0 = dest, x1 = s1_ptr, x2 = s1_len, x3 = s2_ptr, x4 = s2_len
; Returns dest in x0, total length in x1
    .globl _string_concat
_string_concat:
    stp x29, x30, [sp, #-16]!
    mov x29, sp
    stp x19, x20, [sp, #-16]!
    stp x21, x22, [sp, #-16]!

    mov x19, x0                 ; save dest
    mov x20, x2                 ; save s1_len
    mov x21, x4                 ; save s2_len

    ; Copy s1 to dest
    mov x5, #0                  ; index
    cbz x2, Lconcat_s2          ; skip if s1 empty
Lconcat_s1_loop:
    ldrb w6, [x1, x5]
    strb w6, [x0, x5]
    add x5, x5, #1
    cmp x5, x2
    b.lt Lconcat_s1_loop

Lconcat_s2:
    ; Copy s2 after s1
    add x0, x19, x20            ; dest + s1_len
    mov x5, #0                  ; index
    cbz x21, Lconcat_done       ; skip if s2 empty
Lconcat_s2_loop:
    ldrb w6, [x3, x5]
    strb w6, [x0, x5]
    add x5, x5, #1
    cmp x5, x21
    b.lt Lconcat_s2_loop

Lconcat_done:
    mov x0, x19                 ; return dest ptr
    add x1, x20, x21            ; return total length

    ldp x21, x22, [sp], #16
    ldp x19, x20, [sp], #16
    ldp x29, x30, [sp], #16
    ret

; int_to_string: convert integer to string
; x0 = buffer, x1 = integer value
; Returns: x0 = buffer ptr, x1 = string length
    .globl _int_to_string
_int_to_string:
    stp x29, x30, [sp, #-16]!
    mov x29, sp
    stp x19, x20, [sp, #-16]!
    stp x21, x22, [sp, #-16]!

    mov x19, x0                 ; save buffer start
    mov x20, x0                 ; current position
    mov x2, x1                  ; value to convert

    ; Handle negative
    cmp x2, #0
    b.ge Lits_positive
    neg x2, x2
    mov w3, #&#x27;-&#x27;
    strb w3, [x20], #1

Lits_positive:
    mov x21, x20                ; start of digits

    ; Generate digits in reverse
    mov x3, #10
Lits_loop:
    udiv x4, x2, x3             ; quotient
    msub x5, x4, x3, x2         ; remainder = x2 - (x4 * 10)
    add w5, w5, #&#x27;0&#x27;
    strb w5, [x20], #1
    mov x2, x4
    cbnz x2, Lits_loop

    ; Calculate length
    sub x22, x20, x19           ; length

    ; Reverse digits (x21 = start, x20-1 = end)
    sub x20, x20, #1            ; point to last digit
Lits_reverse:
    cmp x21, x20
    b.ge Lits_done
    ldrb w3, [x21]
    ldrb w4, [x20]
    strb w4, [x21], #1
    strb w3, [x20]
    sub x20, x20, #1
    b Lits_reverse

Lits_done:
    mov x0, x19                 ; return buffer ptr
    mov x1, x22                 ; return length

    ldp x21, x22, [sp], #16
    ldp x19, x20, [sp], #16
    ldp x29, x30, [sp], #16
    ret

    .data
    .globl _str_true
_str_true:
    .asciz &quot;true&quot;
    .globl _str_false
_str_false:
    .asciz &quot;false&quot;



    .data
    .globl str_0
str_0:
    .asciz &quot;, &quot;
    .globl str_0_len
str_0_len:
    .quad 2

    ; Static result buffers for string concatenation
    .bss
    .globl _result_buf_eval_customers_full_name
    .p2align 3
_result_buf_eval_customers_full_name:
    .space 1024

    .text

    .globl _eval_customers_full_name
    .p2align 2
_eval_customers_full_name:
    stp x29, x30, [sp, #-16]!
    mov x29, sp
    stp x19, x20, [sp, #-16]!
    stp x21, x22, [sp, #-16]!
    stp x23, x24, [sp, #-16]!
    sub sp, sp, #256
    mov x19, x0
    ldr x0, [x19, #64]
    ldr x1, [x19, #72]
    str x0, [sp, #16]
    str x1, [sp, #24]
    adrp x0, str_0@PAGE
    add x0, x0, str_0@PAGEOFF
    mov x1, #2
    str x0, [sp, #32]
    str x1, [sp, #40]
    ldr x0, [x19, #48]
    ldr x1, [x19, #56]
    str x0, [sp, #48]
    str x1, [sp, #56]
    ldr x0, [sp, #16]
    ldr x1, [sp, #24]
    adrp x22, _result_buf_eval_customers_full_name@PAGE
    add x22, x22, _result_buf_eval_customers_full_name@PAGEOFF
    ldr x4, [sp, #40]
    ldr x3, [sp, #32]
    mov x2, x1
    mov x1, x0
    mov x0, x22
    bl _string_concat
    ldr x4, [sp, #56]
    ldr x3, [sp, #48]
    mov x2, x1
    mov x1, x0
    mov x0, x22
    bl _string_concat
    add sp, sp, #256
    ldp x23, x24, [sp], #16
    ldp x21, x22, [sp], #16
    ldp x19, x20, [sp], #16
    ldp x29, x30, [sp], #16
    ret

</pre>
            </div>
        </div>
        <div id="binary" class="tab-content">
            <div class="card">
                <h2>Generated Artifacts</h2>
                <div class="binary-info">
                    <div class="binary-stat">
                        <div class="binary-stat-value">33.0 KB</div>
                        <div class="binary-stat-label">erb_calc.dylib</div>
                    </div>
                    <div class="binary-stat">
                        <div class="binary-stat-value">1.3 KB</div>
                        <div class="binary-stat-label">erb_calc.o</div>
                    </div>
                    <div class="binary-stat">
                        <div class="binary-stat-value">5.0 KB</div>
                        <div class="binary-stat-label">erb_calc.s</div>
                    </div>
                    <div class="binary-stat">
                        <div class="binary-stat-value">ARM64</div>
                        <div class="binary-stat-label">Architecture</div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script>
const themeToggle = document.getElementById('theme-toggle');
const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
function getInitialTheme() { try { if (window.parent && window.parent.document.documentElement.dataset.theme) return window.parent.document.documentElement.dataset.theme; } catch (e) {} return prefersDark ? 'dark' : 'light'; }
document.documentElement.dataset.theme = getInitialTheme();
themeToggle.addEventListener('click', () => { document.documentElement.dataset.theme = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark'; });
window.addEventListener('message', (event) => { if (event.data.type === 'theme-change') document.documentElement.dataset.theme = event.data.theme; });
document.querySelectorAll('.tab').forEach(tab => { tab.addEventListener('click', () => { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); tab.classList.add('active'); document.getElementById(tab.dataset.tab).classList.add('active'); }); });
function copyCode(elementId) { navigator.clipboard.writeText(document.getElementById(elementId).textContent).then(() => { event.target.textContent = 'Copied!'; setTimeout(() => event.target.textContent = 'Copy', 2000); }); }
    </script>
</body>
</html>